# GitHub Actions workflow: Go compile + upload binary as a workflow artifact,
# and (if present) attach it to a draft release as a release asset.

name: Go Build and Upload

on:
  workflow_dispatch:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: windows-latest
    env:
      BUILD_CMD: 'go build'
      BINARY_PATH: 'direct-share'
      ARTIFACT_NAME: 'direct-share'
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.x'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download modules
        run: go mod download

      - name: Build
        run: |
          set -euo pipefail
          echo "Running build: ${{ BUILD_CMD }}"
          eval "${{ BUILD_CMD }}"

      - name: Verify binary exists
        run: |
          if [ -f "$BINARY_PATH" ]; then
            echo "Binary exists at $BIN_PATH"
          else
            echo "ERROR: Binary not found at $BINARY_PATH"
            ls -la
            exit 1
          fi

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ ARTIFACT_NAME }}
          path: ${{ BINARY_PATH }}

      - name: Find draft release (if any)
        id: find_draft
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const draft = releases.data.find(r => r.draft === true);
            if (!draft) {
              core.setOutput('found', 'false');
              core.info('No draft release found.');
            } else {
              core.setOutput('found', 'true');
              core.setOutput('id', String(draft.id));
              core.setOutput('upload_url', draft.upload_url);
              core.info(`Found draft release id=${draft.id} name='${draft.name || draft.tag_name}'`);
            }

      - name: Upload binary to draft release (if present)
        if: steps.find_draft.outputs.found == 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.find_draft.outputs.upload_url }}
          asset_path: ${{ BINARY_PATH }}
          asset_name: ${{ ARTIFACT_NAME }}
          asset_content_type: application/octet-stream

      - name: Done
        run: echo "Go build and upload complete."
