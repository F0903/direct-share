# GitHub Actions workflow: Go compile + upload binary as a workflow artifact,
# and (if present) attach it to a draft release as a release asset.

name: Go Build and Upload

defaults:
  run:
    shell: bash

on:
  push:

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: windows-latest
    env:
      BUILD_CMD: 'go build'
      BINARY_PATH: 'direct-share.exe'
      ARTIFACT_NAME: 'direct-share'
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.x'

      - name: Build
        run: |
          set -euo pipefail
          echo "Running build: $BUILD_CMD"
          eval "$BUILD_CMD"

      - name: Verify binary exists
        run: |
          if [ -f "$BINARY_PATH" ]; then
            echo "Binary exists at $BINARY_PATH"
          else
            echo "ERROR: Binary not found at $BINARY_PATH"
            ls -la
            exit 1
          fi

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v6
        with:
          name: "$ARTIFACT_NAME"
          path: "$BINARY_PATH"

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: "$BINARY_PATH"

      - name: Done
        run: echo "Go build and upload complete."
